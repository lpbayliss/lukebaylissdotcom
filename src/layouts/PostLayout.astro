---
import type { CollectionEntry } from "astro:content";
import BackToTop from "../components/BackToTop";
import ReadingProgress from "../components/ReadingProgress";
import { calculateReadingTime, formatReadingTime } from "../lib/reading-time";
import BaseLayout from "./BaseLayout.astro";

interface Props {
  entry: CollectionEntry<"blog">;
}

const { entry } = Astro.props as Props;
const { data } = entry;

// Calculate reading time from content if not provided in frontmatter
const { Content } = await entry.render();
const contentBody = entry.body;
const calculatedReadingTime = calculateReadingTime(contentBody);
const readingTime = data.readingTimeMinutes || calculatedReadingTime;

// Generate dynamic OG image URL
const ogImageUrl =
  data.heroImage ||
  `${Astro.site}og-image.png?title=${encodeURIComponent(data.title)}&description=${encodeURIComponent(data.description)}&type=blog`;
---

<BaseLayout
  title={data.title}
  description={data.description}
  ogImage={ogImageUrl}
  ogType="article"
  publishedTime={data.publishedAt}
  modifiedTime={data.updatedAt}
  tags={data.tags}
>
  <ReadingProgress client:load />
  <BackToTop client:load />

  <article class="space-y-6 text-base leading-relaxed text-foreground">
    <header class="mb-8 space-y-2 border-b border-border pb-6">
      <p class="text-xs uppercase tracking-[0.3em] text-foreground-muted">/blog/{entry.slug}</p>
      <h1 class="text-3xl font-semibold">{data.title}</h1>
      <p class="text-sm text-foreground-muted">{data.description}</p>
      <div class="flex flex-wrap items-center gap-3 text-xs uppercase tracking-[0.25em] text-foreground-muted">
        <time datetime={data.publishedAt.toISOString()}>
          {data.publishedAt.toLocaleDateString('en-AU', {
            year: 'numeric',
            month: 'long',
            day: '2-digit'
          })}
        </time>
        {data.updatedAt && (
          <>
            <span aria-hidden="true">·</span>
            <span>
              updated{' '}
              {data.updatedAt.toLocaleDateString('en-AU', {
                year: 'numeric',
                month: 'short',
                day: '2-digit'
              })}
            </span>
          </>
        )}
        <span aria-hidden="true">·</span>
        <span>{formatReadingTime(readingTime)}</span>
      </div>
      {data.tags.length > 0 && (
        <ul class="flex flex-wrap gap-2 text-xs uppercase tracking-[0.25em]">
          {data.tags.map((tag) => (
            <li>
              <a
                href={`/blog/?q=${encodeURIComponent(tag)}`}
                class="inline-block rounded border border-border px-2 py-1 text-foreground-muted hover:border-border-accent hover:text-foreground-accent transition-colors"
              >
                {tag}
              </a>
            </li>
          ))}
        </ul>
      )}
    </header>
    <slot />
  </article>
</BaseLayout>
