---
import { getCollection } from "astro:content";
import SearchComponent from "../../components/Search";
import TerminalPanel from "../../components/TerminalPanel.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { generateSearchIndex } from "../../lib/search-index";

const posts = (await getCollection("blog", ({ data }) => !data.draft)).sort(
  (a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime(),
);

const searchIndex = await generateSearchIndex();
---

<BaseLayout title="Writing">
  <TerminalPanel title="Blog" subtitle="essays, notes, and experiments in writing">
    <div class="space-y-8">
      <SearchComponent client:load searchIndex={searchIndex} />

      {posts.length === 0 ? (
        <p class="text-sm text-foreground-muted">
          No posts yet. Subscribe to the RSS feed soon to hear when the first entries land.
        </p>
      ) : (
        <div>
          <h2 class="text-sm font-semibold text-foreground-muted mb-4">All Posts</h2>
          <ul class="space-y-6 text-sm">
            {posts.map((post) => (
              <li class="space-y-2 border-b border-border pb-4 last:border-b-0 last:pb-0">
                <div>
                  <a class="text-lg font-semibold text-foreground" href={`/blog/${post.slug}/`}>
                    {post.data.title}
                  </a>
                  <p class="text-foreground-muted">{post.data.description}</p>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-xs uppercase tracking-[0.25em] text-foreground-muted">
                  <time datetime={post.data.publishedAt.toISOString()}>
                    {post.data.publishedAt.toLocaleDateString('en-AU', {
                      year: 'numeric',
                      month: 'short',
                      day: '2-digit'
                    })}
                  </time>
                  {post.data.tags.map((tag) => (
                    <a
                      href={`/blog/?q=${encodeURIComponent(tag)}`}
                      class="inline-block rounded border border-border px-2 py-1 hover:border-border-accent hover:text-foreground-accent transition-colors"
                      data-tag={tag}
                    >
                      {tag}
                    </a>
                  ))}
                </div>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  </TerminalPanel>
</BaseLayout>
